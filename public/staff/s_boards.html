<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Trackboard</title>
    <!-- <meta content="" name="descriptison">
    <meta content="" name="keywords"> -->
    
    <!-- Favicons -->
    <!-- <link href="" rel="icon">
    <link href="" rel="apple-touch-icon"> -->

    
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <!-- <script src="..\assets\vendor\jquery\jquery.min.js"></script> -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/vendor/icofont/icofont.min.css">
    <link rel="stylesheet" href="../assets/vendor/boxicons/css/boxicons.min.css">
    <link rel="stylesheet" href="../assets/vendor/animate.css/animate.min.css">
    <link rel="stylesheet" href="../assets/vendor/venobox/venobox.css">
    <link rel="stylesheet" href="../assets/vendor/owl.carousel/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.12.0/css/all.css">
    <link href="https://fonts.googleapis.com/css?family=Bonbon&display=swap" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="sidebar-style.css"/>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script>
      $(function(){
        $("#header").load("../include/staff_header.html"); 
        $("#footer").load("../include/staff_footer.html"); 
      });
    </script> 
  </head>
  <body>
    <!-- Run 'firebase serve' and open localhost to see header and footer, otherwise you get CORS error  -->
    <div id="header"></div>


    <button class="openbtn" id="openbtn" onclick="openNav()">
      â˜°
    </button>
    <div id="mySidebar" class="sidebar">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()"> x </a>
      <a href="./s_requests.html">Poster Requests</a>
      <!-- <a href="./s_map.html">Campus Map</a> -->
      <a href="./s_boards.html">Bulletin Boards</a>
      <a href="./s_rules.html">Poster Rules</a>
    </div>

    <div id="main_content" style="min-width: 1090px; display: flex; padding: 10px;">
      <!-- ======= Boards Section ======= -->
      <section id="portfolio" class="portfolio">
        <div class="container">

          <div class="section-title">
            <h2>BULLETIN BOARDS</h2>
            <small style="color: cornflowerblue;">* Navigate through the posters to check for details. You may add new building location, floor, and  bulletin boards locations</small>
          </div>

          <!-- TODO DYNAMICALLY LOAD CONTENT !! Below is an example -->
          <div id="dropdownList">

          </div>

            <!-- TODO DYNAMICALLY LOAD CONTENT !! Below is an example -->
          <div id="posterBoardViewer" class="row portfolio-container" style="min-width: 1040px; min-height: 720px; max-height: 720px; padding: 11px; margin: 1px; background-color: rgb(180, 203, 204); overflow-y:scroll; display: flex; justify-content: flex-start;"> 
          </div>

          </div>
        </div>
      </section><!-- End Portfolio Section -->


      <div id="footer"></div>
    </div>


    <!-- Template Main JS File -->
    <!-- <script src="../assets/js/main.js"></script> -->
    <script src="../include/firebase_service.js"></script>    

    
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-storage.js"></script>

    <!-- <script src="../include/init_firebase.js"></script> -->
    <script>
        // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyBveio8IuFGOMymSnwNgAWqc14BVliUwHY",
        authDomain: "trackboard-d41a2.firebaseapp.com",
        databaseURL: "https://trackboard-d41a2.firebaseio.com",
        projectId: "trackboard-d41a2",
        storageBucket: "trackboard-d41a2.appspot.com",
        messagingSenderId: "880705427344",
        appId: "1:880705427344:web:43e253a149143cc9218515",
        measurementId: "G-5GLK0MX33D",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();

      var st = firebase.storage().ref();
      var db = firebase.firestore();

    </script>

    <script>

      var bfl = [];
        
      var pos_0 = "";
      var pos_1 = "<div class=\"portfolio-item filter-x wow fadeInUp\" style=\"display: inline; max-width: 50px;\"> <div class=\"portfolio-wrap\"> <figure> <img src=\"";
      var pos_2 = "\" class=\"img-fluid\" alt=\"\"> <a href=\"" ;
      var pos_3 = "\" data-gall=\"portfolioGallery\" class=\"link-preview venobox\" title=\"Preview\"><i class=\"bx bx-plus\"></i></a> <a href=\"\" class=\"link-details\" title=\"More Details\"><i class=\"bx bx-link\"></i></a> </figure><div class=\"portfolio-info\"> <h4><a href=\"\">Uploader</a></h4> <p>Poster Info(?)</p> </div></div>  </div>";
      var pos_4 = "";

      $( document ).ready(getPageData());
      async function getPageData() {
        
        let myParams = getParams(window.location.href);

        // TODO properly get eid from firebase
        let eid = "hI4YnwT1hV8moVbc1Xhc";
        bfl = await getBuildings(eid);

        bfl.forEach( async b => {
          b.floors = await getFloors(b.bid);
          if( b.floors.length > 0 ){
            b.floors.forEach( async f => {
              f.locations = await getLocations(f.fid);
              // if( f.locations.length > 0 ){

              // }
            })
          }
        });

        console.log(bfl);
        if( getBuildingName(myParams.bid) !== "All Buildings"  ){
          selectedBuilding = myParams.bid;
        } else {
          selectedBuilding = "*";
        }
        if( getFloorName(myParams.fid) !== "All Floors" ){
          selectedFloor = myParams.fid;
        } else {
          selectedFloor = "*";
        }
        if( getLocationName(myParams.lid) !== "All Locations" ){
          selectedLocation = myParams.lid;
        } else {
          selectedLocation = "*";
        }
        setDropdowns(selectedBuilding, selectedFloor, selectedLocation); 
      }

        
      function setDropdowns(selB, selF, selL){
        let myBuildings = "";
        let myFloors = "";
        let myLocations = "";
        myBuildings = "<div id=\"buildingDropdownBtn\" class=\"dropdown\" style=\"display: inline-block;\"> <button type=\"button\" class=\"btn btn-primary dropdown-toggle\" data-toggle=\"dropdown\">" + getBuildingName(selB) + " </button> <div class=\"dropdown-menu\"> <a class=\"dropdown-item\" href=\"javascript:setDropdowns('*', '*', '*');\">All Buildings</a>";
        if( selB !== '*' ){
          myFloors = "<div id=\"floorDropdownBtn\" class=\"dropdown\" style=\"display: inline-block;\"> <button type=\"button\" class=\"btn btn-primary dropdown-toggle\" data-toggle=\"dropdown\">" + getFloorName(selF) + "</button> <div class=\"dropdown-menu\"> <a class=\"dropdown-item\" href=\"javascript:setDropdowns('" + selB + "', '*', '*');\">All Floors</a>";
        }
        if( selF !== '*' ){
          myLocations = "<div id=\"locationropdownBtn\" class=\"dropdown\" style=\"display: inline-block;\"> <button type=\"button\" class=\"btn btn-primary dropdown-toggle\" data-toggle=\"dropdown\">" + getLocationName(selL) + "</button> <div class=\"dropdown-menu\"> <a class=\"dropdown-item\" href=\"javascript:setDropdowns('" + selB + "', '" + selF + "', '*');\">All Locations</a>";
        }
        this.bfl.forEach(b => {
          myBuildings = myBuildings + "<a class=\"dropdown-item\" href=\"javascript:setDropdowns('" + b.bid+ "',  '*',  '*');\">" + b.name+"</a>";
          if( selB === b.bid ){
            b.floors.forEach(f => {
              myFloors = myFloors + "<a class=\"dropdown-item\" href=\"javascript:setDropdowns('"+selB+"', '" + f.fid + "',  '*');\">" + f.name + "</a>";
              if( selF === f.fid ){
                f.locations.forEach(l => {
                  myLocations = myLocations + "<a class=\"dropdown-item\" href=\"javascript:setDropdowns('"+selB+"', '"+selF+"', '" + l.lid + "');\">" + l.name + "</a>";
                });
              }
            });
          }
        });
        myBuildings = myBuildings + "<hr><a class=\"dropdown-item\" href=\"javascript:addBuilding()\">Add New Building</a><a class=\"dropdown-item\" href=\"javascript:deleteBuilding()\">Delete Building</a></div></div>";
        if( selB !== '*' ){
          myFloors = myFloors + "<hr><a class=\"dropdown-item\" href=\"javascript:addFloor('" + selB + "')\">Add New Floor</a><a class=\"dropdown-item\" href=\"javascript:deleteFloor('" + selB + "')\">Delete Floor</a></div></div>";
        }
        if( selF !== '*' ){
          myLocations = myLocations + "<hr><a class=\"dropdown-item\" href=\"javascript:addLocation('" + selB + "','"+ selF+"')\">Add New Locations</a><a class=\"dropdown-item\" href=\"javascript:deleteLocation('" + selB + "','"+ selF+"')\">Delete Location</a></div></div>";
        }
        var ddl = $('#dropdownList');
        ddl.html( myBuildings + myFloors + myLocations );
        updatePosterItems(selB, selF, selL);
      }

      async function updatePosterItems(bid, fid, lid){
        var pbv = $('#posterBoardViewer');
        // var loadPosters = this.pos_0;
        var loadPosters = "";
        let img_link = "";
        for( let b of this.bfl ){
          if( bid === '*' || bid === b.bid ){
            for( let f of b.floors ){
              if( fid === '*' || fid === f.fid ){
                for( let l of f.locations ){
                  if( lid === '*' || lid === l.lid ){
                    if( l.posters.length > 0 ){
                      loadPosters = loadPosters + `<h5>` + b.name + ` > ` + f.name + `>` + l.name + `<br><br>`;
                      for( let p of l.posters ){
                        if( !(   (bid === '*') 
                              || (bid === b.bid && fid === '*') 
                              || (bid === b.bid && fid === f.fid && lid === '*') 
                              || (bid === b.bid && fid === f.fid && lid === l.lid) ) ){
                          continue;
                        } else {
                          if( p === null ){
                            // TODO set default 'available spot' poster
                            img_link = "../assets/img/posters/available.jpg";
                          } else {
                            img_link = await getPosterByName(p);
                          }
                          loadPosters = loadPosters + this.pos_1 + img_link + this.pos_2 + img_link + this.pos_3;
                          pbv.html(loadPosters);
                        }
                      }
                      loadPosters = loadPosters + `<br>`;
                      pbv.html(loadPosters);

                    }
                    
                  }
                }
              }
            }
          }
        }
        // pbv.html(loadPosters);
        // loadPosters = loadPosters + this.pos_4;
      }

      function getBuildingName(bid){ 
        if( bid === '*' ){ return "All Buildings"; }
        for( let b of this.bfl ){
          if(bid === b.bid){
            return b.name;
          }
        }
        return "All Buildings";
      }
      function getFloorName(fid){ 
        if( fid === '*' ){ return "All Floors"; }
        for( let b of this.bfl ){
          for( let f of b.floors ){
            if(fid === f.fid){
              return f.name;
            }
          }
        }
        return "All Floors";
      }
      function getLocationName(lid){
        if( lid === '*' ){ return "All Locations"; }
        for( let b of this.bfl ){
          for( let f of b.floors ){
            for( let l of f.locations ){
              if(lid === l.lid){
                return l.name;
              }
            }
          }
        }
        return "All Locations";
      }

      function buildingNameExists(bname){
        for( let b of this.bfl ){
          if(bname === b.name){
            return true;
          }
        }
        return false;
      }
      function floorNameExists(inBid, fname){
        for( let b of this.bfl ){
          if( inBid === b.bid ){
            for( let f of b.floors ){
              if(fname === f.name){
                return true;
              }
            }
          }
        }
        return false;
      }
      function locationNameExists(inBid, inFid, lname){
        for( let b of this.bfl ){
          if( inBid === b.bid ){
            for( let f of b.floors ){
              if( inFid === f.fid ){
                for( let l of f.locations ){
                  if(lname === l.name){
                    return true;
                  }
                }
              }
            }
          }
        }
        return false;
      }

      function addBuilding(){
        let newBdName = prompt("Enter the name of the building you want to add");
        if( newBdName !== "" && newBdName !== null ){
          if( buildingNameExists(newBdName)){
            alert("Building with name \""+newBdName+"\" already exists");
          } else if( confirm("Add Building with name \:" + newBdName + "\"?" ) ){
            alert("Successfully added building with name \"" + newBdName + "\"." );
          }
        }
      }
      function addFloor( inBid ){
        let newFlName = prompt("Enter the name of the Floor you want to add");
        if( newFlName !== "" && newFlName !== null ){
          if( floorNameExists( inBid, newFlName)){
            alert("Floor with name \""+newFlName+"\" already exists");
          } else if( confirm("Add Floor with name \"" + newFlName + "\"?" ) ){
            // TODO Call database to add Floor
            alert("Successfully added a floor with name " + newFlName + "\"."  );
          }
        }
      }
      function addLocation( inBid, inFid ){
        let newLcName = prompt("Enter the name of the Location you want to add");
        if( newLcName !== "" && newLcName !== null ){
          if( locationNameExists( inBid, inFid, newLcName)){
            alert("Location with name \""+newLcName+"\" already exists");
          } else if( confirm("Add Location with name \"" + newLcName + "\"?") ){
            // TODO Call database to add Location
            alert("Successfully added a location with name " + newLcName + "\"."  );
          }
        }
      }
      function deleteBuilding(){
        let delBdName = prompt("WARNING: DELETION OF A BUILDING WILL DELETE ALL FLOORS, LOCATIONS, AND POSTERS RELATED TO THIS BUILDING\n\nEnter the name of the building you want to delete.");
        if( delBdName !== "" && delBdName !== null ){
          if( !buildingNameExists(delBdName)){
            alert("Building with name \""+delBdName+"\" does not exist");
          } else if( confirm("Confirm deletion of Building with name \"" + delBdName + "\"?" ) ){
            alert("Successfully deleted building with name \"" + delBdName + "\"." );
          }
        }
      }
      function deleteFloor( inBid ){
        let delFlName = prompt("WARNING: DELETION OF A FLOOR WILL DELETE ALL LOCATIONS AND POSTERS RELATED TO THIS FLOOR\n\nEnter the name of the floor you want to delete.");
        if( delFlName !== "" && delFlName !== null ){
          if( !floorNameExists( inBid, delFlName)){
            alert("Floor with name \""+delFlName+"\" does not exist");
          } else if( confirm("Confirm deletion of Floor with name \"" + delFlName + "\"?" ) ){
            // TODO call database to delete Floor
            alert("Successfully deleted floor with name " + delFlName + "\"."  );
          }
        }
      }
      function deleteLocation( inBid, inFid ){
        let delLcName = prompt("WARNING: DELETION OF A LOCATION WILL DELETE ALL POSTERS RELATED TO THIS LOCATION\n\nEnter the name of the location you want to delete.");
        if( delLcName !== "" && delLcName !== null ){
          if( !locationNameExists( inBid, inFid, delLcName)){
            alert("Location with name \""+delLcName+"\" does not exist");
          } else if( confirm("Confrim deletions of Location with name \"" + delLcName + "\"?") ){
            // TODO call database to delete Location
            alert("Successfully deleted location with name " + delLcName + "\"."  );
          }
        }
      }


      /**
      * Get the URL parameters
      * source: https://css-tricks.com/snippets/javascript/get-url-variables/
      * @param  {String} url The URL
      * @return {Object}     The URL parameters
      */
      // var getParams = function (url) {
      //   var params = {};
      //   var parser = document.createElement('a');
      //   parser.href = url;
      //   var query = parser.search.substring(1);
      //   var vars = query.split('&');
      //   for (var i = 0; i < vars.length; i++) {
      //     var pair = vars[i].split('=');
      //     params[pair[0]] = decodeURIComponent(pair[1]);
      //   }
      //   return params;
      // };
      function getParams(url) {
        var params = {};
        var parser = document.createElement('a');
        parser.href = url;
        var query = parser.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          params[pair[0]] = decodeURIComponent(pair[1]);
        }
        return params;
      };

 
     
    </script>
    <script src="sidebar.js"></script>    
  </body>
</html>